<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LoomSpeak – Model Output</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        --warm-cream: #faf8f5;
        --soft-beige: #f5f1eb;
        --warm-gray: #8b7355;
        --sage-green: #9caf88;
        --terracotta: #d4a574;
        --deep-brown: #5d4e37;
        --soft-orange: #e8b4a0;
        --warm-white: #fefcf9;
        --muted-blue: #6b7280;
        --muted-blue-light: #f3f4f6;
        --muted-blue-dark: #4b5563;
        --accent-teal: #64748b;
        --accent-coral: #78716c;
        --accent-sage: #6b7280;
      }

      body {
        background: #fff;
        font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          Cantarell, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
        color: #0f172a;
        line-height: 1.7;
        margin: 0;
        padding: 30px;
        font-weight: 400;
        min-height: 100vh;
        position: relative;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 10px 30px rgba(2, 6, 23, 0.06);
        position: relative;
        overflow: hidden;
        z-index: 1;
      }

      .container::before {
        content: "";
        position: absolute;
        top: -1px;
        left: -1px;
        right: -1px;
        bottom: -1px;
        background: linear-gradient(
          45deg,
          var(--muted-blue),
          var(--accent-teal),
          var(--accent-coral)
        );
        border-radius: 12px;
        z-index: -1;
        opacity: 0.25;
      }

      h1 {
        font-size: 2.2em;
        margin: 0;
        color: #0f172a;
        font-weight: 600;
        letter-spacing: -0.3px;
      }

      h2 {
        font-size: 1.2em;
        margin-bottom: 12px;
        color: var(--warm-gray);
        border-bottom: 1px solid var(--sage-green);
        padding-bottom: 6px;
        font-weight: 500;
        display: inline-block;
      }

      .btn {
        padding: 10px 16px;
        border: 1px solid #e2e8f0;
        background: #fff;
        color: #0f172a;
        cursor: pointer;
        font-family: "Inter", sans-serif;
        font-size: 14px;
        font-weight: 500;
        margin: 6px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        border-radius: 8px;
        transition: all 0.2s ease;
        letter-spacing: 0.2px;
      }
      .btn:hover {
        background: var(--sage-green);
        color: var(--warm-white);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(156, 175, 136, 0.2);
      }
      .btn-primary {
        background: #0052cc;
        color: #fff;
        border-color: #0052cc;
      }
      .btn-primary:hover {
        background: var(--muted-blue-dark);
        border-color: var(--muted-blue-dark);
      }

      .section {
        margin-bottom: 24px;
        padding: 20px;
        border: 1px dashed #e2e8f0;
        border-radius: 12px;
        background: #fff;
      }

      .output-area {
        width: 100%;
        min-height: 220px;
        padding: 14px;
        border-radius: 12px;
        border: 1px dashed #e2e8f0;
        background: #f8fafc;
        font-family: "Inter", ui-monospace, SFMono-Regular, Menlo, Monaco,
          Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.95em;
        line-height: 1.6;
        resize: vertical;
      }

      .links-list a {
        color: #1d4ed8;
        text-decoration: underline;
      }
      .links-list a:hover {
        color: #1e40af;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div
        style="
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 16px;
        "
      >
        <h1>
          <i class="fas fa-file-alt" style="margin-right: 10px"></i>Model Output
        </h1>
        <a href="/app" class="btn btn-primary"
          ><i class="fas fa-arrow-left" style="margin-right: 8px"></i>Go Back</a
        >
      </div>
      <p class="text-gray-600" style="margin: 10px 0 22px 0">
        Review and refine the generated content. Add related links below.
      </p>

      <div class="section">
        <h2>Input Text</h2>
        <textarea
          id="modelOutput"
          class="output-area"
          placeholder="Enter text to parse with Gemini and create Jira/Confluence items..."
        ></textarea>
      </div>

      <div class="section">
        <h2>Latest Parsed Actions</h2>
        <div
          style="
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
          "
        >
          <button id="refreshBtn" class="btn">
            <i class="fas fa-sync-alt" style="margin-right: 6px"></i>Refresh
          </button>
          <button id="copyJsonBtn" class="btn">
            <i class="fas fa-copy" style="margin-right: 6px"></i>Copy JSON
          </button>
          <span id="metaInfo" class="text-sm" style="opacity: 0.7"></span>
        </div>
        <pre
          id="latestJson"
          class="output-area"
          style="min-height: 220px; white-space: pre-wrap; overflow: auto"
        >
No parsed result yet.
            </pre
        >
      </div>

      <div class="section">
        <h2>Action Summary</h2>
        <div
          id="actionsList"
          style="display: grid; grid-template-columns: 1fr; gap: 12px"
        ></div>
      </div>

      <div class="section" style="margin-bottom: 0">
        <h2>Related Links</h2>
        <div id="linksArea" class="links-list">
          <ul id="linksList" style="padding-left: 18px; margin: 10px 0">
            <!-- Links will appear here -->
          </ul>
          <div
            style="
              display: flex;
              gap: 8px;
              flex-wrap: wrap;
              align-items: center;
            "
          >
            <input
              id="linkText"
              type="text"
              placeholder="Link title"
              class="border rounded px-3 py-2"
              style="flex: 1; min-width: 180px"
            />
            <input
              id="linkUrl"
              type="url"
              placeholder="https://..."
              class="border rounded px-3 py-2"
              style="flex: 2; min-width: 220px"
            />
            <button id="addLinkBtn" class="btn">
              <i class="fas fa-plus" style="margin-right: 6px"></i>Add Link
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Configuration
      const GEMINI_API_KEY = 'your-gemini-api-key-here'; // Replace with actual key
      const CLOUD_ID = 'dubhacks'; // Your cloud ID
      
      // Get token from localStorage (set by OAuth flow) or environment
      function getAtlassianToken() {
        return localStorage.getItem('atlassian_token') || process.env.ATLASSIAN_TOKEN || '';
      }

      (function () {
        // Load latest parsed result from the backend
        const latestJsonEl = document.getElementById("latestJson");
        const refreshBtn = document.getElementById("refreshBtn");
        const copyJsonBtn = document.getElementById("copyJsonBtn");
        const metaInfo = document.getElementById("metaInfo");
        const actionsList = document.getElementById("actionsList");

        async function loadLatest() {
          try {
            const res = await fetch("/api/last", { cache: "no-store" });
            if (!res.ok) {
              const text = await res.text();
              latestJsonEl.textContent = `No parsed result yet (status ${
                res.status
              }).\n${text.slice(0, 200)}`;
              metaInfo.textContent = "";
              renderActions([]);
              return;
            }
            const data = await res.json();
            latestJsonEl.textContent = JSON.stringify(data, null, 2);
            const count = Array.isArray(data?.actions)
              ? data.actions.length
              : 0;
            const ts = data?.metadata?.timestamp || new Date().toISOString();
            metaInfo.textContent = `Actions: ${count} • Updated: ${ts}`;
            renderActions(data.actions || []);
          } catch (e) {
            latestJsonEl.textContent = `Error loading latest result: ${e.message}`;
            metaInfo.textContent = "";
            renderActions([]);
          }
        }

        refreshBtn?.addEventListener("click", loadLatest);
        copyJsonBtn?.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(latestJsonEl.textContent || "");
            const prev = copyJsonBtn.innerHTML;
            copyJsonBtn.innerHTML =
              '<i class="fas fa-check" style="margin-right: 6px"></i>Copied!';
            setTimeout(() => (copyJsonBtn.innerHTML = prev), 1200);
          } catch (e) {}
        });
        // Auto-load on page ready
        loadLatest();

        function pill(text) {
          const span = document.createElement("span");
          span.textContent = text;
          span.style.padding = "2px 8px";
          span.style.borderRadius = "9999px";
          span.style.border = "1px solid #e5e7eb";
          span.style.background = "#f9fafb";
          span.style.fontSize = "12px";
          span.style.whiteSpace = "nowrap";
          return span;
        }

        function renderActions(actions) {
          actionsList.innerHTML = "";
          if (!Array.isArray(actions) || actions.length === 0) {
            const empty = document.createElement("div");
            empty.textContent = "No actions to display yet.";
            empty.style.opacity = "0.7";
            actionsList.appendChild(empty);
            return;
          }

          actions.forEach((a, idx) => {
            const card = document.createElement("div");
            card.style.border = "1px solid #e2e8f0";
            card.style.borderRadius = "12px";
            card.style.padding = "14px";
            card.style.background = "#fff";
            card.style.boxShadow = "0 1px 2px rgba(2,6,23,0.03)";

            const header = document.createElement("div");
            header.style.display = "flex";
            header.style.justifyContent = "space-between";
            header.style.alignItems = "center";
            header.style.marginBottom = "8px";

            const left = document.createElement("div");
            left.style.display = "flex";
            left.style.gap = "8px";
            left.appendChild(pill(a?.target || "unknown"));
            left.appendChild(pill(a?.action || "unknown"));

            const idxEl = document.createElement("div");
            idxEl.style.opacity = "0.6";
            idxEl.style.fontSize = "12px";
            idxEl.textContent = `#${idx + 1}`;

            header.appendChild(left);
            header.appendChild(idxEl);
            card.appendChild(header);

            if (a?.title) {
              const title = document.createElement("div");
              title.style.fontWeight = "600";
              title.style.marginBottom = "6px";
              title.textContent = a.title;
              card.appendChild(title);
            }

            const details = document.createElement("div");
            details.style.fontSize = "14px";
            details.style.lineHeight = "1.6";

            if (a?.identifier) {
              const idKeys = Object.entries(a.identifier)
                .filter(([k, v]) => v)
                .map(([k, v]) => `${k}: ${v}`)
                .join(" • ");
              if (idKeys) {
                const row = document.createElement("div");
                row.innerHTML = `<strong>Identifier:</strong> ${idKeys}`;
                details.appendChild(row);
              }
            }

            if (a?.data) {
              const keys = [
                "issueType",
                "priority",
                "assignee",
                "dueDate",
                "summary",
              ];
              const parts = [];
              keys.forEach((k) => {
                if (a.data[k]) parts.push(`${k}: ${a.data[k]}`);
              });
              if (parts.length) {
                const row = document.createElement("div");
                row.innerHTML = `<strong>Data:</strong> ${parts.join(" • ")}`;
                details.appendChild(row);
              }
            }

            card.appendChild(details);
            actionsList.appendChild(card);
          });
        }

        const addBtn = document.getElementById("addLinkBtn");
        const list = document.getElementById("linksList");
        const text = document.getElementById("linkText");
        const url = document.getElementById("linkUrl");

        function addLink() {
          const t = (text.value || "").trim();
          const u = (url.value || "").trim();
          if (!u) return;
          const li = document.createElement("li");
          li.style.margin = "6px 0";
          const a = document.createElement("a");
          a.href = u;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = t || u;
          li.appendChild(a);
          list.appendChild(li);
          text.value = "";
          url.value = "";
        }

        addBtn.addEventListener("click", addLink);
        url.addEventListener("keydown", function (e) {
          if (e.key === "Enter") addLink();
        });
        text.addEventListener("keydown", function (e) {
          if (e.key === "Enter") addLink();
        });

        // Gemini API integration
        async function parseWithGemini(text) {
          if (!GEMINI_API_KEY || GEMINI_API_KEY === 'your-gemini-api-key-here') {
            console.error('Gemini API key not configured');
            return null;
          }

          try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                contents: [{
                  parts: [{
                    text: `Parse this text and extract actionable items for Jira and Confluence. Return a JSON object with this exact structure:
{
  "actions": [
    {
      "action": "create_issue" or "update_issue" or "create_page",
      "title": "Brief title",
      "target": "jira" or "confluence",
      "data": {
        "description": "Detailed description",
        "summary": "Brief summary"
      }
    }
  ]
}

Text to parse: ${text}`
                  }]
                }]
              })
            });

            const result = await response.json();
            const content = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (content) {
              return JSON.parse(content);
            }
          } catch (error) {
            console.error('Gemini parsing error:', error);
          }
          return null;
        }

        // Atlassian API calls
        async function createJiraIssue(issueData) {
          const token = getAtlassianToken();
          
          if (!token) {
            return { success: false, error: 'No Atlassian token found. Please authenticate first.' };
          }
          
          try {
            // For personal access tokens, use Basic Auth with token as username
            const auth = btoa(`${token}:`);
            const response = await fetch(`https://${CLOUD_ID}.atlassian.net/rest/api/3/issue`, {
              method: 'POST',
              headers: {
                'Authorization': `Basic ${auth}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                fields: {
                  project: { key: 'LOOM' }, // LoomSpeak project
                  summary: issueData.title,
                  description: {
                    type: 'doc',
                    version: 1,
                    content: [{
                      type: 'paragraph',
                      content: [{
                        type: 'text',
                        text: issueData.data.description || issueData.data.summary || ''
                      }]
                    }]
                  },
                  issuetype: { name: 'Task' }
                }
              })
            });

            if (response.ok) {
              const result = await response.json();
              return { success: true, key: result.key, id: result.id };
            } else {
              const error = await response.text();
              console.error('Jira API error:', error);
              return { success: false, error };
            }
          } catch (error) {
            console.error('Jira creation error:', error);
            return { success: false, error: error.message };
          }
        }

        async function createConfluencePage(pageData) {
          const token = getAtlassianToken();
          
          if (!token) {
            return { success: false, error: 'No Atlassian token found. Please authenticate first.' };
          }
          
          try {
            // For personal access tokens, use Basic Auth with token as username
            const auth = btoa(`${token}:`);
            const response = await fetch(`https://${CLOUD_ID}.atlassian.net/wiki/rest/api/content`, {
              method: 'POST',
              headers: {
                'Authorization': `Basic ${auth}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                type: 'page',
                title: pageData.title,
                space: { key: 'loomspeak' }, // Use the loomspeak space
                body: {
                  storage: {
                    value: `<h2>${pageData.title}</h2><p>${pageData.data.description || pageData.data.summary || ''}</p>`,
                    representation: 'storage'
                  }
                }
              })
            });

            if (response.ok) {
              const result = await response.json();
              return { success: true, id: result.id, url: result._links?.webui };
            } else {
              const error = await response.text();
              console.error('Confluence API error:', error);
              return { success: false, error };
            }
          } catch (error) {
            console.error('Confluence creation error:', error);
            return { success: false, error: error.message };
          }
        }

        // Process actions and show results
        async function processActions() {
          const text = document.getElementById('modelOutput')?.value;
          if (!text || !text.trim()) {
            alert('Please enter some text to process');
            return;
          }

          const parseResult = await parseWithGemini(text);
          if (!parseResult || !parseResult.actions) {
            alert('Failed to parse text or no actions found');
            return;
          }

          const results = [];
          for (const action of parseResult.actions) {
            let result;
            if (action.action === 'create_issue' || action.action === 'update_issue') {
              result = await createJiraIssue(action);
              if (result.success) {
                results.push(`Jira issue created: ${result.key}`);
              }
            } else if (action.action === 'create_page') {
              result = await createConfluencePage(action);
              if (result.success) {
                results.push(`Confluence page created: ${action.title}`);
              }
            }
          }

          // Show results
          if (results.length > 0) {
            alert(`Successfully created ${results.length} items:\n${results.join('\n')}`);
          } else {
            alert('No items were created successfully');
          }
        }

        // Add process button and auth check to the page
        document.addEventListener('DOMContentLoaded', function() {
          const outputArea = document.getElementById('modelOutput');
          if (outputArea) {
            const buttonContainer = document.createElement('div');
            buttonContainer.style.marginTop = '10px';
            buttonContainer.style.display = 'flex';
            buttonContainer.style.gap = '8px';
            buttonContainer.style.flexWrap = 'wrap';
            
            const processBtn = document.createElement('button');
            processBtn.textContent = 'Process with Gemini & Create Items';
            processBtn.className = 'btn btn-primary';
            processBtn.onclick = processActions;
            
            const authBtn = document.createElement('button');
            authBtn.textContent = 'Authenticate with Atlassian';
            authBtn.className = 'btn';
            authBtn.onclick = () => {
              // Redirect to OAuth flow
              window.location.href = '/oauth/login';
            };
            
            // Check if already authenticated
            if (getAtlassianToken()) {
              authBtn.textContent = '✓ Authenticated';
              authBtn.disabled = true;
              authBtn.style.opacity = '0.7';
            }
            
            buttonContainer.appendChild(processBtn);
            buttonContainer.appendChild(authBtn);
            
            const section = outputArea.parentElement;
            section.appendChild(buttonContainer);
          }
        });
      })();
    </script>
  </body>
</html>
